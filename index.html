<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#1e293b">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Mercado Manu Pro v127</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { color-scheme: light !important; }
        html, body { 
            margin: 0; padding: 0; height: 100%; width: 100%; 
            overscroll-behavior-y: none !important; 
            overflow: hidden; background-color: #f1f5f9; position: fixed; 
        }
        #appWrapper { 
            height: 100%; width: 100%; overflow-y: auto; 
            -webkit-overflow-scrolling: touch; 
            overscroll-behavior-y: none !important; 
            display: flex; flex-direction: column; 
        }
        .card-item { background: white; padding: 15px; border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-left: 5px solid transparent; }
        .comprado { opacity: 0.5 !important; background: #e2e8f0 !important; text-decoration: line-through; border-left-color: #94a3b8 !important; }
        
        #customConfirm { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); z-index: 9999; align-items: center; justify-content: center; padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 300px; padding: 25px; border-radius: 25px; text-align: center; }
        #customConfirm.show { display: flex; }

        .footer-sticky { position: fixed; bottom: 75px; left: 0; right: 0; background: #1e293b; padding: 15px 20px; color: white; border-top: 2px solid #6366f1; z-index: 150; }
        .nav-fixed { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; align-items: center; z-index: 200; padding-bottom: 15px; }
        
        .content-section { display: none; padding-bottom: 250px; }
        .active-section { display: block; }
        
        .sugerencia-link { padding: 15px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; font-weight: 800; text-transform: uppercase; font-size: 13px; color: #1e293b; background: white; }
        .detalles-historial { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px dashed #cbd5e1; }
        .detalles-historial.open { display: block; }
        
        .spinning { animation: spin 0.8s ease-in-out; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body onload="inicializar()">

    <div id="customConfirm">
        <div class="modal-content">
            <h3 class="text-lg font-black mb-1 uppercase text-slate-800">Â¿Confirmar?</h3>
            <p class="text-xs text-slate-500 font-bold mb-6 italic">Manu, Â¿estÃ¡s seguro?</p>
            <div class="flex gap-3">
                <button onclick="cerrarConfirm(false)" class="flex-1 py-3 bg-slate-100 text-slate-500 font-black rounded-xl uppercase text-[10px]">No</button>
                <button onclick="cerrarConfirm(true)" class="flex-1 py-3 bg-red-600 text-white font-black rounded-xl uppercase text-[10px]">SÃ­</button>
            </div>
        </div>
    </div>

    <div id="appWrapper">
        <div id="secCalc" class="content-section active-section">
            <div id="headerPanel" class="p-6 text-white bg-[#d97706] shadow-xl transition-colors duration-500">
                <div class="flex justify-between items-center mb-4">
                    <div class="bg-black/20 p-2 px-3 rounded-2xl flex items-center gap-2 border border-white/20">
                        <span class="text-[10px] font-black text-yellow-300 italic">BCV</span>
                        <input type="tel" id="tasa" class="bg-transparent font-black w-20 text-white text-xl outline-none" oninput="guardarTasaManual(this.value)">
                        <button onclick="fetchBCV()" id="btnRefresh">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3"><path d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0013.803-3.7M4.031 9.865a8.25 8.25 0 0113.803-3.7l3.181 3.182m0-4.991v4.99"></path></svg>
                        </button>
                    </div>
                    <button onclick="confirmarAccion('carrito')" class="bg-red-600/80 backdrop-blur-sm text-[10px] font-black uppercase px-4 py-2 rounded-xl italic">Limpiar</button>
                </div>
                <div class="text-center">
                    <div id="displaySaldo" class="text-6xl font-black tracking-tighter">0,00</div>
                    <div class="mt-2"><span id="displayEquiv" class="text-sm font-black text-white/80 bg-black/10 px-5 py-1.5 rounded-full italic">0,00 Bs</span></div>
                </div>
            </div>

            <div class="p-5 space-y-5">
                <div class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                    <div class="flex gap-2 p-1.5 bg-slate-100 rounded-2xl mb-4">
                        <button id="btnPUSD" onclick="setMonedaP('USD')" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-[#d97706] text-white shadow-md">Tengo $</button>
                        <button id="btnPBS" onclick="setMonedaP('BS')" class="flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-white text-slate-400">Tengo Bs</button>
                    </div>
                    <input type="tel" id="inputPresupuesto" placeholder="0,00" class="w-full text-5xl font-black text-center bg-transparent text-slate-800 outline-none" oninput="recalculoRapido()">
                </div>

                <div class="flex gap-2">
                    <div class="flex-[3] relative">
                        <input type="text" id="nombreProd" oninput="gestionarEscritura(this.value, 'sugerenciasIA')" placeholder="Â¿QUÃ‰ COMPRAS?" class="w-full p-4 rounded-2xl font-black border-2 border-slate-100 text-center uppercase text-sm outline-none">
                        <div id="sugerenciasIA" class="hidden absolute w-full bg-white border-2 rounded-2xl z-[500] mt-1 max-h-64 overflow-y-auto shadow-2xl"></div>
                    </div>
                    <div class="flex-1"><input type="tel" id="cantProd" placeholder="CANT." class="w-full p-4 rounded-2xl font-black border-2 border-indigo-100 text-center text-sm outline-none"></div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <input type="tel" id="inputUSD" placeholder="PRECIO $" class="w-full p-5 border-2 border-amber-200 rounded-2xl text-center font-black text-amber-700 text-xl outline-none" onkeydown="handleEnter(event)">
                    <input type="tel" id="inputBS" placeholder="PRECIO Bs" class="w-full p-5 border-2 border-emerald-200 rounded-2xl text-center font-black text-emerald-700 text-xl outline-none" onkeydown="handleEnter(event)">
                </div>

                <button onclick="aÃ±adir()" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase text-sm italic">AÃ±adir al Carrito</button>
                <div id="contenedorLista" class="space-y-4 pt-2"></div>
            </div>
        </div>

        <div id="secPlan" class="content-section">
            <div class="p-6">
                <h2 class="text-2xl font-black text-slate-800 uppercase italic mb-6 border-b-4 border-amber-500 inline-block">Lista de Pendientes</h2>
                <div class="bg-white p-6 rounded-3xl border border-slate-200 space-y-4 mb-6 shadow-sm">
                    <div class="relative">
                        <input type="text" id="nombrePlan" oninput="gestionarEscritura(this.value, 'sugPlan')" placeholder="PRODUCTO..." class="w-full p-4 rounded-2xl font-black border-2 border-slate-50 text-center uppercase text-xs outline-none">
                        <div id="sugPlan" class="hidden absolute w-full bg-white border-2 rounded-2xl z-[500] mt-1 shadow-2xl overflow-y-auto max-h-48"></div>
                    </div>
                    <div class="flex gap-2">
                         <input type="tel" id="cantPlan" placeholder="CANT." class="w-full p-4 rounded-2xl border-2 border-slate-50 text-center font-black outline-none">
                         <button onclick="agregarAlPlan()" class="bg-amber-500 text-white font-black px-6 rounded-2xl shadow-md uppercase text-xs italic">Anotar</button>
                    </div>
                </div>
                <div id="contenedorPlan" class="space-y-3"></div>
            </div>
        </div>

        <div id="secHist" class="content-section">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-black text-slate-800 uppercase italic border-b-4 border-indigo-500">Historial</h2>
                    <button onclick="confirmarAccion('historial_todo')" class="text-red-500 font-bold bg-red-50 px-4 py-2 rounded-xl text-xs uppercase">Borrar</button>
                </div>
                <div id="listaHistorial" class="space-y-4"></div>
            </div>
        </div>
    </div>

    <div id="footerTotales" class="footer-sticky flex justify-between items-center">
        <div class="flex flex-col">
            <div id="totalGastoBs" class="text-2xl font-black text-emerald-400 leading-none">0,00 Bs</div>
            <div id="totalGastoUsd" class="text-lg font-black text-indigo-300 italic mt-1">0,00 $</div>
        </div>
        <button onclick="finalizar()" class="bg-indigo-500 px-7 py-3.5 rounded-2xl font-black text-xs uppercase italic">Finalizar</button>
    </div>

    <nav class="nav-fixed">
        <button onclick="verPestaÃ±a('calc')" id="btnNavCalc" class="flex flex-col items-center text-indigo-600">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span class="text-[10px] font-black uppercase mt-1">Carrito</span>
        </button>
        <button onclick="verPestaÃ±a('plan')" id="btnNavPlan" class="flex flex-col items-center text-slate-400">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span class="text-[10px] font-black uppercase mt-1">Lista</span>
        </button>
        <button onclick="verPestaÃ±a('hist')" id="btnNavHist" class="flex flex-col items-center text-slate-400">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-[10px] font-black uppercase mt-1">Historial</span>
        </button>
    </nav>

    <script>
        let productMemory = JSON.parse(localStorage.getItem('manu_products_v127')) || {
            'POLLO': 'ðŸ—', 'CARNE': 'ðŸ¥©', 'BISTEC': 'ðŸ¥©', 'CHULETA': 'ðŸ¥“', 'MOLIDA': 'ðŸ¥©', 'PESCADO': 'ðŸŸ', 'ATUN': 'ðŸŸ', 'SARDINA': 'ðŸŸ', 'COCHINO': 'ðŸ–', 'SALCHICHA': 'ðŸŒ­', 'JAMON': 'ðŸ¥“', 'HUEVO': 'ðŸ¥š',
            'CAMBUR': 'ðŸŒ', 'PLATANO': 'ðŸŒ', 'MANZANA': 'ðŸŽ', 'PERA': 'ðŸ', 'NARANJA': 'ðŸŠ', 'LIMON': 'ðŸ‹', 'PATILLA': 'ðŸ‰', 'MELON': 'ðŸˆ', 'FRESA': 'ðŸ“', 'UVA': 'ðŸ‡', 'PIÃ‘A': 'ðŸ', 'AGUACATE': 'ðŸ¥‘', 'LECHOSA': 'ðŸ¥­', 'MANGO': 'ðŸ¥­',
            'PAPA': 'ðŸ¥”', 'CEBOLLA': 'ðŸ§…', 'TOMATE': 'ðŸ…', 'AJO': 'ðŸ§„', 'PIMENTON': 'ðŸ«‘', 'ZANAHORIA': 'ðŸ¥•', 'LECHUGA': 'ðŸ¥¬', 'YUCA': 'ðŸªµ', 'OCUMO': 'ðŸ¥”', 'CALABACIN': 'ðŸ¥’', 'REPOLLO': 'ðŸ¥¬', 'BRÃ“COLI': 'ðŸ¥¦', 'BERENJENA': 'ðŸ†', 'CILANTRO': 'ðŸŒ¿',
            'HARINA': 'ðŸ¥¯', 'ARROZ': 'ðŸš', 'PASTA': 'ðŸ', 'ESPAGUETI': 'ðŸ', 'ACEITE': 'ðŸ›¢ï¸', 'AZUCAR': 'ðŸ¬', 'SAL': 'ðŸ§‚', 'CAFE': 'â˜•', 'LECHE': 'ðŸ¥›', 'QUESO': 'ðŸ§€', 'MANTEQUILLA': 'ðŸ§ˆ', 'MAYONESA': 'ðŸ§´', 'SALSA': 'ðŸ¥«', 'GRANO': 'ðŸ«˜', 'CARAOTA': 'ðŸ«˜', 'LENTEJA': 'ðŸ«˜', 'PAN': 'ðŸž', 'GALLETA': 'ðŸª', 'AVENA': 'ðŸ¥£',
            'JABON': 'ðŸ§¼', 'DETERGENTE': 'ðŸ§¼', 'CLORO': 'ðŸ§ª', 'DESINFECTANTE': 'ðŸ§¹', 'CHAMPU': 'ðŸ§´', 'PAPEL': 'ðŸ§»', 'CREMA': 'ðŸª¥', 'DESODORANTE': 'âœ¨', 'PANAL': 'ðŸ‘¶', 'TOALLA': 'ðŸ§¼'
        };

        let carrito = [];
        let planCompras = JSON.parse(localStorage.getItem('plan_v127')) || [];
        let historial = JSON.parse(localStorage.getItem('hist_v127')) || [];
        let monedaP = localStorage.getItem('manu_moneda_v127') || 'USD';
        let confirmCallback = null;

        function obtenerIcono(n) { 
            const u = n.toUpperCase(); 
            for (let k in productMemory) { if (u.includes(k)) return productMemory[k]; } 
            return "ðŸ“¦"; 
        }

        function fmt(n) { return parseFloat(n).toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function aÃ±adir() {
            const n = document.getElementById('nombreProd').value.trim().toUpperCase() || "PRODUCTO", cant = parseFloat(document.getElementById('cantProd').value) || 1;
            const iU = document.getElementById('inputUSD'), iB = document.getElementById('inputBS');
            let valor = (iU.value || iB.value).replace(/,/g, '.'); if (!valor) return;
            let mon = iU.value ? 'USD' : 'BS', unit = parseFloat(valor) || 0;
            if (unit > 0) { 
                if (!productMemory[n]) { productMemory[n] = "ðŸ“¦"; localStorage.setItem('manu_products_v127', JSON.stringify(productMemory)); }
                carrito.push({ id: Date.now(), nombre: n, icon: obtenerIcono(n), unit, cantidad: cant, montoTotal: unit * cant, moneda: mon }); 
                iU.value = ''; iB.value = ''; document.getElementById('nombreProd').value = ''; document.getElementById('cantProd').value = ''; recalculoRapido(); 
            }
        }

        function recalculoRapido() {
            const tasa = parseFloat(document.getElementById('tasa').value.replace(',', '.')) || 1;
            const presuRaw = document.getElementById('inputPresupuesto').value.replace(',', '.');
            const presu = parseFloat(presuRaw) || 0;
            
            let tBs = 0, tUsd = 0; const listaDiv = document.getElementById('contenedorLista'); listaDiv.innerHTML = '';
            carrito.slice().reverse().forEach(item => {
                let uBs = item.moneda === 'USD' ? item.unit * tasa : item.unit;
                let uUsd = item.moneda === 'BS' ? item.unit / tasa : item.unit;
                let tProdBs = item.moneda === 'USD' ? item.montoTotal * tasa : item.montoTotal;
                let tProdUsd = item.moneda === 'BS' ? item.montoTotal / tasa : item.montoTotal;
                tBs += tProdBs; tUsd += tProdUsd;
                listaDiv.innerHTML += `
                <div class="card-item border-l-indigo-500">
                    <div class="flex justify-between items-start mb-1">
                        <b class="text-sm font-black uppercase text-slate-700">${item.icon} ${item.nombre} (x${item.cantidad})</b>
                        <button onclick="carrito=carrito.filter(i=>i.id!==${item.id});recalculoRapido();" class="text-red-400 font-bold">âœ•</button>
                    </div>
                    <div class="text-[10px] text-slate-500 font-bold italic mb-1 border-b border-slate-50 pb-1">Unit: ${fmt(uBs)} Bs | ${fmt(uUsd)} $</div>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-[10px] text-slate-400 font-black uppercase">Sub-Total:</span>
                        <div class="text-right"><span class="text-indigo-600 font-black text-lg block leading-none">${fmt(tProdBs)} Bs</span><span class="text-indigo-400 font-black text-xs italic">${fmt(tProdUsd)} $</span></div>
                    </div>
                </div>`;
            });

            let sBs, sUsd;
            if (monedaP === 'USD') { sUsd = presu - tUsd; sBs = sUsd * tasa; } 
            else { sBs = presu - tBs; sUsd = sBs / tasa; }

            document.getElementById('displaySaldo').innerText = (monedaP === 'USD' ? fmt(sUsd) : fmt(sBs));
            document.getElementById('displayEquiv').innerText = (monedaP === 'USD' ? fmt(sBs) + " Bs" : fmt(sUsd) + " $");
            document.getElementById('totalGastoUsd').innerText = fmt(tUsd) + " $"; 
            document.getElementById('totalGastoBs').innerText = fmt(tBs) + " Bs";
            
            localStorage.setItem('manu_presupuesto_v127', presuRaw);
            return { sBs, sUsd, tBs, tUsd }; 
        }

        function finalizar() {
            if (carrito.length === 0) return;
            const tasa = parseFloat(document.getElementById('tasa').value.replace(',', '.')), c = recalculoRapido();
            historial.unshift({ id: Date.now(), fecha: new Date().toLocaleString(), tasa: tasa.toFixed(2), monedaPresu: monedaP, presu: document.getElementById('inputPresupuesto').value, totalBs: fmt(c.tBs), totalUsd: fmt(c.tUsd), sobraBs: fmt(c.sBs), sobraUsd: fmt(c.sUsd), detalles: [...carrito] });
            localStorage.setItem('hist_v127', JSON.stringify(historial));
            carrito = []; 
            document.getElementById('inputPresupuesto').value = '';
            recalculoRapido(); renderHistorial(); verPestaÃ±a('hist');
        }

        function reabrirCompra(id) {
            const i = historial.findIndex(h => h.id === id);
            if (i > -1) {
                const comp = historial[i];
                carrito = [...comp.detalles];
                document.getElementById('inputPresupuesto').value = comp.presu;
                setMonedaP(comp.monedaPresu);
                historial.splice(i, 1);
                guardarHist();
                recalculoRapido();
                verPestaÃ±a('calc');
            }
        }

        function shareWS(id) {
            const h = historial.find(x => x.id === id);
            let msg = `ðŸ›’ *COMPRA MANU PRO*\nðŸ“… ${h.fecha}\nðŸ’° Tasa: ${h.tasa} Bs\n--------------------------\n`;
            h.detalles.forEach(d => {
                let tH = parseFloat(h.tasa);
                let uBs = d.moneda === 'USD' ? d.unit * tH : d.unit;
                let uUsd = d.moneda === 'BS' ? d.unit / tH : d.unit;
                let tProdBs = d.moneda === 'USD' ? d.montoTotal * tH : d.montoTotal;
                let tProdUsd = d.moneda === 'BS' ? d.montoTotal / tH : d.montoTotal;
                msg += `${d.icon} *${d.nombre} (x${d.cantidad})*\n   Unit: ${fmt(uBs)} Bs / ${fmt(uUsd)} $\n   Sub-Total: ${fmt(tProdBs)} Bs / ${fmt(tProdUsd)} $\n`;
            });
            msg += `--------------------------\nðŸ’µ *TOTAL COMPRA:*\n${h.totalBs} Bs / ${h.totalUsd} $\nâœ… *SOBRÃ“:* ${h.sobraBs} Bs / ${h.sobraUsd} $`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
        }

        function renderHistorial() {
            document.getElementById('listaHistorial').innerHTML = historial.map(h => `
                <div class="card-item border-l-indigo-600">
                    <div onclick="toggleDetalle(${h.id})">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] text-slate-400 font-bold">${h.fecha}</span>
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); shareWS(${h.id})" class="bg-emerald-500 text-white p-1 px-2 rounded-lg shadow-sm">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.438 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.414 0 .004 5.412.001 12.049c0 2.123.554 4.197 1.605 6.046L0 24l6.103-1.603a11.83 11.83 0 005.94 1.595h.005c6.635 0 12.046-5.413 12.049-12.05a11.81 11.81 0 00-3.417-8.525z"/></svg>
                                </button>
                                <span class="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md font-black italic">TASA: ${h.tasa}</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-end">
                            <div class="flex flex-col"><span class="font-black text-indigo-900 text-lg leading-none">${h.totalBs} Bs</span><span class="text-indigo-400 font-black text-xs italic">${h.totalUsd} $</span></div>
                            <div class="text-right bg-emerald-50 p-2 rounded-xl">
                                <p class="text-[8px] text-emerald-600 font-black uppercase mb-1">Sobra Manu</p>
                                <p class="text-emerald-700 font-black text-xs leading-none">${h.sobraBs} Bs</p>
                                <p class="text-emerald-500 font-black text-[10px] italic">${h.sobraUsd} $</p>
                            </div>
                        </div>
                    </div>
                    <div id="detalle-${h.id}" class="detalles-historial">
                        ${h.detalles.map(d => {
                            let tH = parseFloat(h.tasa);
                            let uBs = d.moneda === 'USD' ? d.unit * tH : d.unit;
                            let uUsd = d.moneda === 'BS' ? d.unit / tH : d.unit;
                            let tProdBs = d.moneda === 'USD' ? d.montoTotal * tH : d.montoTotal;
                            let tProdUsd = d.moneda === 'BS' ? d.montoTotal / tH : d.montoTotal;
                            return `
                            <div class="text-[10px] border-b border-slate-50 py-3 font-bold text-slate-600">
                                <div class="flex justify-between uppercase"><span>${d.icon} ${d.nombre} (x${d.cantidad})</span></div>
                                <div class="text-slate-400 text-[9px] italic mt-1">Unit: ${fmt(uBs)} Bs | ${fmt(uUsd)} $</div>
                                <div class="flex justify-between mt-1 text-indigo-600"><span>Sub-Total:</span><span>${fmt(tProdBs)} Bs | ${fmt(tProdUsd)} $</span></div>
                            </div>`;
                        }).join('')}
                        <button onclick="confirmarAccion('reabrir', ${h.id})" class="w-full mt-4 bg-indigo-600 text-white py-3 rounded-xl text-[10px] font-black uppercase italic shadow-md">Recuperar esta Compra</button>
                    </div>
                </div>`).join('');
        }

        function agregarAlPlan() {
            const nom = document.getElementById('nombrePlan').value.trim().toUpperCase(), cant = document.getElementById('cantPlan').value || "1";
            if (!nom) return; planCompras.push({ id: Date.now(), nombre: nom, cantidad: cant, tachado: false });
            document.getElementById('nombrePlan').value = ''; document.getElementById('cantPlan').value = ''; guardarPlan();
        }

        function toggleTachado(id) {
            const i = planCompras.findIndex(x => x.id === id);
            if (i > -1) { 
                planCompras[i].tachado = !planCompras[i].tachado; 
                if(planCompras[i].tachado) {
                    document.getElementById('nombreProd').value = planCompras[i].nombre;
                    document.getElementById('cantProd').value = planCompras[i].cantidad;
                    verPestaÃ±a('calc');
                }
            }
            guardarPlan();
        }

        function renderPlan() {
            document.getElementById('contenedorPlan').innerHTML = planCompras.map(p => `
                <div class="card-item flex justify-between items-center ${p.tachado ? 'comprado' : 'border-l-amber-500'}" onclick="toggleTachado(${p.id})">
                    <div class="flex flex-col"><span class="font-black text-sm uppercase text-slate-700">${obtenerIcono(p.nombre)} ${p.nombre}</span><span class="text-[10px] font-bold italic text-slate-400">Cant: ${p.cantidad}</span></div>
                    <button onclick="event.stopPropagation(); planCompras=planCompras.filter(x=>x.id!==${p.id}); guardarPlan();" class="text-red-300 font-black px-2">âœ•</button>
                </div>`).join('');
        }

        function confirmarAccion(tipo, id = null) {
            const mod = document.getElementById('customConfirm');
            if(tipo === 'carrito') confirmCallback = () => { carrito = []; recalculoRapido(); };
            else if(tipo === 'historial_todo') confirmCallback = () => { historial = []; guardarHist(); };
            else if(tipo === 'reabrir') confirmCallback = () => { reabrirCompra(id); };
            mod.classList.add('show');
        }

        function cerrarConfirm(aceptar) { document.getElementById('customConfirm').classList.remove('show'); if(aceptar && confirmCallback) confirmCallback(); confirmCallback = null; }
        function toggleDetalle(id) { document.getElementById(`detalle-${id}`).classList.toggle('open'); }
        function guardarHist() { localStorage.setItem('hist_v127', JSON.stringify(historial)); renderHistorial(); }
        function guardarPlan() { localStorage.setItem('plan_v127', JSON.stringify(planCompras)); renderPlan(); }
        
        function verPestaÃ±a(p) { 
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active-section')); 
            document.getElementById('sec' + p.charAt(0).toUpperCase() + p.slice(1)).classList.add('active-section'); 
            document.getElementById('footerTotales').style.display = (p === 'calc' ? 'flex' : 'none');
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-indigo-600', 'text-slate-400'));
            document.getElementById('btnNav' + p.charAt(0).toUpperCase() + p.slice(1)).classList.replace('text-slate-400', 'text-indigo-600');
        }

        function setMonedaP(m) { 
            monedaP = m; 
            localStorage.setItem('manu_moneda_v127', m);
            const head = document.getElementById('headerPanel');
            if(m === 'USD') { head.style.backgroundColor = "#d97706"; document.getElementById('btnPUSD').className = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-[#d97706] text-white shadow-md"; document.getElementById('btnPBS').className = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-white text-slate-400"; } 
            else { head.style.backgroundColor = "#059669"; document.getElementById('btnPBS').className = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-[#059669] text-white shadow-md"; document.getElementById('btnPUSD').className = "flex-1 py-3 rounded-xl font-black text-[10px] uppercase bg-white text-slate-400"; }
            recalculoRapido(); 
        }

        async function fetchBCV() { 
            const btn = document.getElementById('btnRefresh'); btn.classList.add('spinning');
            try { const res = await fetch('https://ve.dolarapi.com/v1/dolares/oficial'); const data = await res.json(); if (data.promedio) { document.getElementById('tasa').value = data.promedio.toFixed(2); guardarTasaManual(data.promedio.toFixed(2)); } } catch (e) {} 
            setTimeout(() => btn.classList.remove('spinning'), 800);
        }

        function gestionarEscritura(v, divId) {
            const div = document.getElementById(divId);
            if (!v) { div.classList.add('hidden'); return; }
            const filtrados = Object.keys(productMemory).filter(p => p.includes(v.toUpperCase())).slice(0, 10);
            div.innerHTML = filtrados.map(p => `<div class="sugerencia-link" onclick="seleccionarIA('${p}', '${divId}')"><span>${productMemory[p]}</span><span>${p}</span></div>`).join('');
            div.classList.toggle('hidden', filtrados.length === 0);
        }

        function seleccionarIA(p, divId) { const inputId = divId === 'sugerenciasIA' ? 'nombreProd' : 'nombrePlan'; document.getElementById(inputId).value = p; document.getElementById(divId).classList.add('hidden'); }
        function guardarTasaManual(v) { localStorage.setItem('lastBCV', v); recalculoRapido(); }
        function handleEnter(e) { if (e.key === "Enter") { e.preventDefault(); e.target.blur(); setTimeout(aÃ±adir, 100); } }
        
        function inicializar() { 
            document.getElementById('tasa').value = localStorage.getItem('lastBCV') || "60.00"; 
            document.getElementById('inputPresupuesto').value = localStorage.getItem('manu_presupuesto_v127') || "";
            setMonedaP(monedaP);
            renderPlan(); renderHistorial(); recalculoRapido(); 
        }
    </script>
</body>
</html>
